<div class="page-container">
  <header class="page-header">
    <div class="header-actions">
      <button class="icon-button" (click)="onBack()">
        <i class="fas fa-arrow-left"></i> Back
      </button>
      <button class="icon-button" (click)="onEdit()">
        <i class="fas fa-edit"></i> Edit
      </button>
      <button class="icon-button danger" (click)="onDelete()">
        <i class="fas fa-trash"></i> Delete
      </button>
    </div>
  </header>

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading project details...</p>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage && !isLoading) {
    <div class="error-state">
      <i class="fas fa-exclamation-circle"></i>
      <p>{{ errorMessage }}</p>
      <button class="btn btn-primary" (click)="navigateToProjects()">Back to Projects</button>
    </div>
  }

  <!-- Project Content -->
  @if (selectedProject && !isLoading) {
    <div class="project-content">
      <div class="project-header">
        <div class="project-title-section">
          <div class="title-status">
            <h1>{{ selectedProject.name }}</h1>
            @if (selectedProject.completionStatus) {
              <span class="status-badge" [ngClass]="getStatusClass(selectedProject.completionStatus)">
                {{ selectedProject.completionStatus }}
              </span>
            }
          </div>
          <p class="project-description">{{ selectedProject.description || 'No description provided' }}</p>
        </div>
      </div>
      <div class="project-progress-card">
        <div class="progress-header">
          <h3>Project Progress</h3>
          <span class="progress-percentage">{{ selectedProject.progress }}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="selectedProject.progress" [style.backgroundColor]="getProgressBarColor()"></div>
        </div>
        <div class="project-details-grid">
          <div class="detail-item">
            <label>Start Date</label>
            <p>{{ formatDate(selectedProject.dateCreated) }}</p>
          </div>
          <div class="detail-item">
            <label>Due Date</label>
            <p>{{ formatDate(selectedProject.dueDate) }}</p>
          </div>
          <div class="detail-item">
            <label>Priority</label>
            @if (selectedProject.priority) {
              <p class="priority" [ngClass]="getPriorityClass(selectedProject.priority)">
                {{ selectedProject.priority }}
              </p>
            }
            @if (!selectedProject.priority) {
              <p>Not set</p>
            }
          </div>
          <div class="detail-item">
            <label>Status</label>
            @if (isProjectOverdue()) {
              <p class="overdue-text">
                <i class="fas fa-exclamation-triangle"></i> Overdue
              </p>
            }
            @if (!isProjectOverdue() && getDaysUntilDue() !== null) {
              <p>
                {{ getDaysUntilDue() }} days remaining
              </p>
            }
          </div>
        </div>
      </div>
      <section class="tasks-section">
        <div class="section-header">
          <h2>Project Tasks ({{ getCompletedTaskCount() }}/{{ getTotalTaskCount() }})</h2>
          <button class="btn btn-secondary btn-sm" (click)="addNewTask()">Add Task</button>
        </div>
        @if (projectTasks.length > 0) {
          <div class="task-list">
            @for (task of projectTasks; track trackByTaskId($index, task)) {
              <div class="task-item"
                (click)="viewTaskDetails(task.id)"
                [ngClass]="{'completed': task.isCompleted}">
                <input type="checkbox" [checked]="task.isCompleted">
                <div class="task-content">
                  <h4>{{ task.name }}</h4>
                  <p>{{ task.description || 'No description' }}</p>
                </div>
                @if (task.dueDate) {
                  <span class="task-date">{{ formatDate(task.dueDate) }}</span>
                }
              </div>
            }
          </div>
        } @else {
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <p>No tasks have been added to this project yet</p>
            <button class="btn btn-primary" (click)="addNewTask()">Create Task</button>
          </div>
        }
      </section>
      <section class="technologies-section">
        <h2>Technologies Used</h2>
        <div class="tech-grid">
          @for (tech of technologies; track trackByTechId($index, tech)) {
            <div class="tech-card" (click)="viewTechnologyDetails(tech.id)">
              <div class="tech-icon">
                @if (tech.name === 'React') {
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <circle cx="12" cy="12" r="4"></circle>
                    <line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line>
                    <line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line>
                    <line x1="14.83" y1="9.17" x2="19.07" y2="4.93"></line>
                    <line x1="14.83" y1="9.17" x2="18.36" y2="5.64"></line>
                    <line x1="4.93" y1="19.07" x2="9.17" y2="14.83"></line>
                  </svg>
                }
                @if (tech.name === 'Node.js') {
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                }
                @if (tech.name === 'TypeScript') {
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="4 17 10 11 4 5"></polyline>
                    <line x1="12" y1="19" x2="20" y2="19"></line>
                  </svg>
                }
              </div>
              <div class="tech-info">
                <h4>{{ tech.name }}</h4>
                <div class="proficiency-bar">
                  <div class="proficiency-fill" [style.width.%]="tech.proficiency"></div>
                </div>
                <span class="proficiency-text">{{ tech.proficiency }}% proficiency</span>
              </div>
            </div>
          }
        </div>
      </section>
      <section class="project-notes">
        <div class="section-header">
          <h2>Comments ({{ comments.length }})</h2>
          @if (!isAddingComment) {
            <button class="btn btn-secondary btn-sm" (click)="addComment()">
              <i class="fas fa-plus"></i> Add Comment
            </button>
          }
        </div>
        <!-- Add Comment Form -->
        @if (isAddingComment) {
          <div class="comment-form-card">
            <div class="form-header">
              <h4>Add New Comment</h4>
              <button class="icon-button" (click)="cancelComment()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <textarea
              class="comment-textarea"
              [(ngModel)]="newCommentContent"
              placeholder="Write your comment here..."
              rows="4"
              (input)="onCommentInputChange($event)"
              autofocus>
            </textarea>
            <div class="form-actions">
              <button class="btn btn-secondary" (click)="cancelComment()">Cancel</button>
              <button
                class="btn btn-primary"
                (click)="saveComment()"
                [disabled]="!newCommentContent.trim()">
                <i class="fas fa-check"></i> Save Comment
              </button>
            </div>
          </div>
        }
        <!-- Comments List -->
        @if (comments.length > 0) {
          <div class="comments-list">
            @for (comment of comments; track trackByCommentId($index, comment)) {
              <div class="note-card">
                <div class="note-header">
                  <div class="note-author">
                    <div class="author-avatar">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                      </svg>
                    </div>
                    <div class="author-info">
                      <h4>{{ comment.name || 'Anonymous' }}</h4>
                      @if (comment.dateCreated) {
                        <span>{{ formatDate(comment.dateCreated) }}</span>
                      }
                      @if (!comment.dateCreated) {
                        <span>Just now</span>
                      }
                    </div>
                  </div>
                  <button class="icon-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="12" cy="12" r="1"></circle>
                      <circle cx="12" cy="5" r="1"></circle>
                      <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                  </button>
                </div>
                <div class="comment-content">
                  <p>{{ comment.content }}</p>
                </div>
              </div>
            }
          </div>
        } @else {
          @if (!isAddingComment) {
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              <p>No comments yet. Be the first to comment!</p>
              <button class="btn btn-primary" (click)="addComment()">Add Comment</button>
            </div>
          }
        }
      </section>
      <footer class="page-footer">
        <div class="footer-left">
          Last updated: {{ formatDate(selectedProject.lastModified) }}
        </div>
      </footer>
    </div>
  } @else {
    <div class="not-found">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <h2>Project not found</h2>
      <p>The project you're looking for doesn't exist or has been removed.</p>
      <button class="btn btn-primary" (click)="navigateToProjects()">Go Back to Projects</button>
    </div>
  }

</div>
